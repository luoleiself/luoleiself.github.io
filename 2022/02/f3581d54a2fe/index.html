<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/favicon-32x32.png" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"luoleiself.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="RSC(React Server Component)ISR(Incremental Static Regeneration) Server Component可以在服务器上渲染和缓存的 UI, 在 next.js 中, 渲染工作进一步按路由段划分, 以实现流式和部分渲染  数据获取, 将数据获取移动到更靠近数据源的服务器上, 可以减少获取渲染所需数据的时间以及客户端需要发出的请求数量来提高性能">
<meta property="og:type" content="article">
<meta property="og:title" content="React-Nextjs.md">
<meta property="og:url" content="https://luoleiself.github.io/2022/02/f3581d54a2fe/index.html">
<meta property="og:site_name" content="luoleiself&#39;s blog">
<meta property="og:description" content="RSC(React Server Component)ISR(Incremental Static Regeneration) Server Component可以在服务器上渲染和缓存的 UI, 在 next.js 中, 渲染工作进一步按路由段划分, 以实现流式和部分渲染  数据获取, 将数据获取移动到更靠近数据源的服务器上, 可以减少获取渲染所需数据的时间以及客户端需要发出的请求数量来提高性能">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-02-15T07:37:49.000Z">
<meta property="article:modified_time" content="2025-04-09T11:48:55.988Z">
<meta property="article:author" content="luoleiself">
<meta property="article:tag" content="js">
<meta property="article:tag" content="jsx">
<meta property="article:tag" content="React">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://luoleiself.github.io/2022/02/f3581d54a2fe/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>React-Nextjs.md | luoleiself's blog</title>
  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?5fa63b434a4b3e74b6258584372c74c0";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="luoleiself's blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">luoleiself's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">blog</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>站点地图</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/luoleiself" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://luoleiself.github.io/2022/02/f3581d54a2fe/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="luoleiself">
      <meta itemprop="description" content="努力的往前飞, 再累也无所谓, 黑夜过后的光芒有多美...">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="luoleiself's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          React-Nextjs.md
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-02-15 15:37:49" itemprop="dateCreated datePublished" datetime="2022-02-15T15:37:49+08:00">2022-02-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-04-09 19:48:55" itemprop="dateModified" datetime="2025-04-09T19:48:55+08:00">2025-04-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ES/" itemprop="url" rel="index"><span itemprop="name">ES</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ES/React/" itemprop="url" rel="index"><span itemprop="name">React</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>23k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>21 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>RSC(React Server Component)<br>ISR(Incremental Static Regeneration)</p>
<h2 id="Server-Component"><a href="#Server-Component" class="headerlink" title="Server Component"></a>Server Component</h2><p>可以在服务器上渲染和缓存的 UI, 在 next.js 中, 渲染工作进一步按路由段划分, 以实现流式和部分渲染</p>
<ul>
<li>数据获取, 将数据获取移动到更靠近数据源的服务器上, 可以减少获取渲染所需数据的时间以及客户端需要发出的请求数量来提高性能</li>
<li>安全性, 在服务器上保留敏感数据和逻辑, 例如 token 和 API keys, 而不会将它们暴露给客户端</li>
<li>缓存, 通过在服务器上渲染, 结果可以被缓存并在后续请求和跨用户中重用, 减少每个请求的渲染和数据获取量</li>
<li>性能, 减少所需的客户端 javascript 的数量, 对于弱网环境或设备较弱的用户来说需要下载、解析和执行的客户端 javascript 较少</li>
<li>初始化页面加载和首次内容绘制(FCP), 在服务器上生成 HTML, 允许用户立即查看页面而无需等客户端下载、解析和执行渲染页面所需要的 javascript</li>
<li>SEO 和 社交网络共享(SNS), 渲染的 HTML 可供搜索引擎机器人用来检索页面, 社交网络机器人可用于为页面生成社交卡预览</li>
<li>流式传输, 服务器组件允许将渲染工作分成块, 并在准备就绪时将其流式传输到客户端. 这允许用户提前查看页面的部分内容, 而无需等待整个页面在服务器上渲染</li>
</ul>
<p>渲染策略</p>
<ul>
<li>Static Rendering, 路由在构建时渲染, 或在数据重新验证后在后台渲染, 结果被缓存. 以优化用户和服务器请求之间共享渲染的结果</li>
<li>Dynamic Redering, 在请求时渲染路由, 针对个性化的数据或只有在请求时才知道的信息</li>
<li>Streaming, 从服务器逐步渲染 UI, 并在准备就绪时流式传输给客户端, 允许用户在整个内容完整渲染之前立即看到页面的部分内容.<br>有助于提高初始化页面加载性能, 以及依赖于较慢数据获取的 UI. 可以使用 Suspense 组件和 loading.tsx 开启</li>
</ul>
<p>渲染流程:</p>
<ol>
<li>按单个路由段和 Suspense Boundaries 拆分块</li>
<li>每个块使用 RSC Payload 和 客户端组件 JavaScript 指令渲染 HTML, 然后返回给客户端</li>
<li>客户端立即显示路由的快速非交互式页面预览, 这仅适用于初始化页面加载</li>
<li>RSC Payload 用于协调客户端和 RSC 树并更新 DOM, JavaScript 指令用于 hydrate 客户端组件并使应用程序具有交互性</li>
</ol>
<h2 id="RSC-Payload"><a href="#RSC-Payload" class="headerlink" title="RSC Payload"></a>RSC Payload</h2><p>渲染 RSC 树的紧凑二进制表示形式, 包含</p>
<ul>
<li>RSC 的渲染结果</li>
<li>客户端组件应渲染的占位符及其 JavaScript 文件的引用</li>
<li>从 RSC 传递给客户端组件的任何信息</li>
</ul>
<h3 id="Server-Action"><a href="#Server-Action" class="headerlink" title="Server Action"></a>Server Action</h3><p>是一个在服务器上执行的异步函数, 它们可以在服务器和客户端组件之间调用, 以处理 Next.js 应用程序中的表单和提交和数据突变</p>
<ul>
<li>不限于 &lt;form&gt;, 可以从 Event Handlers、useEffect、第三方库和其他表单元素 &lt;button&gt; 调用</li>
<li>与 Next.js cache 和 revalidate 集成, 当调用一个 action 时, Next.js 可以在单个服务器往返中返回更新的 UI 和新数据</li>
<li>使用 HTTP 的 POST 方法调用</li>
<li>接收的参数 和 返回值 必须可由 React 序列化</li>
<li>可以在应用程序的任何地方重复使用</li>
<li>从其使用的 layout 和 page 继承 运行时</li>
<li>从其使用的 layout 和 page 继承路由段设置, 包含 maxDuration 等字段</li>
</ul>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/invoices/page.tsx</span></span><br><span class="line"><span class="string">&#x27;use client&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">React</span>, &#123; useActionState &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; createInvoice &#125; <span class="keyword">from</span> <span class="string">&#x27;./action&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">InitialStateType</span> = &#123; <span class="attr">message</span>: <span class="built_in">string</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="attr">initialState</span>: <span class="title class_">InitialStateType</span> = &#123; <span class="attr">message</span>: <span class="string">&#x27;&#x27;</span>&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Page</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [state, formAction, pending] = <span class="title function_">useActionState</span>(createInvoice, initialState)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&#123;formAction&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;customerId&quot;</span> <span class="attr">className</span>=<span class="string">&#x27;border-1 border-blue-300 rounded-2xl py-2 px-4 my-4&#x27;</span> <span class="attr">placeholder</span>=<span class="string">&#x27;customer id&#x27;</span> /&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">p</span> <span class="attr">className</span>=<span class="string">&#x27;text-red-500 text-xl&#x27;</span>&gt;</span>&#123;state?.message&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;amount&quot;</span> <span class="attr">className</span>=<span class="string">&#x27;border-1 border-blue-300 rounded-2xl py-2 px-4 my-4&#x27;</span> <span class="attr">placeholder</span>=<span class="string">&#x27;amount&#x27;</span> /&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attr">name</span>=<span class="string">&quot;status&quot;</span> <span class="attr">className</span>=<span class="string">&#x27;w-4 h-6 border-blue-300 border-1 rounded-2xl&#x27;</span> /&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">disabled</span>=<span class="string">&#123;pending&#125;</span> <span class="attr">className</span>=<span class="string">&#x27;border-1 border-blue-300 rounded-2xl py-2 px-4 text-2xl text-gray-600 enabled:hover:border-blue-700 enabled:hover:text-white cursor-pointer&#x27;</span>&gt;</span>Submit<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">br</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// app/invoices/action.ts</span></span><br><span class="line"><span class="string">&#x27;use server&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; redirect &#125; <span class="keyword">from</span> <span class="string">&quot;next/navigation&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">type</span> &#123; <span class="title class_">InitialStateType</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./page&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">createInvoice</span>(<span class="params"><span class="attr">prevState</span>: <span class="title class_">InitialStateType</span>, <span class="attr">formData</span>: <span class="title class_">FormData</span></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> customerId = formData.<span class="title function_">get</span>(<span class="string">&#x27;customerId&#x27;</span>);</span><br><span class="line">  <span class="keyword">const</span> amount = formData.<span class="title function_">get</span>(<span class="string">&#x27;amount&#x27;</span>);</span><br><span class="line">  <span class="keyword">const</span> status = formData.<span class="title function_">get</span>(<span class="string">&#x27;status&#x27;</span>);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(customerId, amount, status);</span><br><span class="line">  <span class="comment">// mutate data</span></span><br><span class="line">  <span class="comment">// revaliate cache</span></span><br><span class="line">  <span class="keyword">await</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> <span class="built_in">setTimeout</span>(resolve, <span class="number">3000</span>));</span><br><span class="line">  <span class="comment">// 如果 customerId 不符合条件则返回提示信息</span></span><br><span class="line">  <span class="keyword">if</span> (!customerId || <span class="title class_">Number</span>(customerId) &gt; <span class="number">100</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123; ...prevState, <span class="attr">message</span>: <span class="string">&#x27;Please enter a valid customer ID&#x27;</span> &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">redirect</span>(<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<span id="more"></span>

<p>在 useEffect 中使用</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/view-count.tsx</span></span><br><span class="line"><span class="string">&#x27;use client&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; incrementViews &#125; <span class="keyword">from</span> <span class="string">&#x27;./actions&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; useState, useEffect &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">ViewCount</span>(<span class="params">&#123; initialViews &#125;: &#123; initialViews: <span class="built_in">number</span> &#125;</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [views, setViews] = <span class="title function_">useState</span>(initialViews)</span><br><span class="line"> </span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">updateViews</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">      <span class="keyword">const</span> updatedViews = <span class="keyword">await</span> <span class="title function_">incrementViews</span>()</span><br><span class="line">      <span class="title function_">setViews</span>(updatedViews)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">updateViews</span>()</span><br><span class="line">  &#125;, [])</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>Total Views: &#123;views&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Components"><a href="#Components" class="headerlink" title="Components"></a>Components</h3><ul>
<li><p>Font 设置字体</p>
</li>
<li><p>Form 扩展了 HTML form 元素并提供了 UI 加载的预获取, 客户端提交的导航, 渐进式增强</p>
<ul>
<li>action string, Form 的行为和普通的 HTML form 一致将使用 get 请求 form 数据被编码为 url 的查询参数</li>
<li>action function, Form 提交时将会执行 Server Action</li>
</ul>
</li>
<li><p>Image 设置图片</p>
</li>
<li><p>Link 扩展了 HTML a 元素提供预获取和路由导航</p>
</li>
<li><p>Script 设置 js 资源</p>
</li>
</ul>
<h2 id="文件规范"><a href="#文件规范" class="headerlink" title="文件规范"></a>文件规范</h2><p>Component hierarchy</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">Layout</span>&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">Template</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">ErrorBoundary</span> <span class="attr">fallback</span>=<span class="string">&#123;</span>&lt;<span class="attr">Error</span> /&gt;</span>&#125;&gt;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Suspense</span> <span class="attr">fallback</span>=<span class="string">&#123;</span>&lt;<span class="attr">Loading</span> /&gt;</span>&#125;&gt;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">ErrorBoundary</span> <span class="attr">fallback</span>=<span class="string">&#123;</span>&lt;<span class="attr">NotFound</span> /&gt;</span>&#125;&gt;</span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">Page</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">ErrorBoundary</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">Suspense</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">ErrorBoundary</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">Template</span>&gt;</span></span></span><br><span class="line">&lt;/<span class="title class_">Layout</span>&gt;</span><br></pre></td></tr></table></figure>

<p>应用根目录或 src 目录下</p>
<ul>
<li>middleware.ts 在请求完成之前在服务器上运行代码, 根据传入的请求修改响应, 对于实现自定义服务器端逻辑非常有用, 配合 <code>matcher</code> 使用过滤指定范围的请求<ul>
<li>request</li>
</ul>
</li>
<li>instrumentation.ts 用于将可观察工具集成到应用程序中, 能够跟踪性能和行为, 并在生产中调试问题</li>
</ul>
<p>路由文件</p>
<ul>
<li><p>layout.tsx 在多个页面之间共享布局的UI, 能够保持跨路由的状态、交互性, 不会重新渲染.</p>
<ul>
<li>Props<ul>
<li>children</li>
<li>params 动态路由参数, 一个 Promise, Next.js 14 之前是同步的</li>
<li>…slot 动态插槽</li>
</ul>
</li>
</ul>
</li>
<li><p>template.tsx 类似于 layout.tsx 能够包含布局和页面, 当路由发生改变时会重置状态</p>
<ul>
<li>Props<ul>
<li>children</li>
</ul>
</li>
</ul>
</li>
<li><p>route.ts 使用 Web Request 和 Response API 为给定的路由创建自定义请求处理程序, 和 page.tsx 不能同时存在</p>
<ul>
<li>request</li>
<li>context</li>
</ul>
</li>
<li><p>page.tsx 定义路由独有的页面UI</p>
<ul>
<li>Props<ul>
<li>params 动态路由参数, 一个 Promise, Next.js 14 之前是同步的</li>
<li>searchParams 当前 URL 的查询字符串参数, 一个 Promise, Next.js 14 之前是同步的</li>
</ul>
</li>
</ul>
</li>
<li><p>loading.tsx 创建基于加载时的状态, 配合 <code>Suspense</code> 组件使用</p>
</li>
<li><p>not-found.tsx 路由未匹配到时渲染的 UI, 默认自动匹配 app 目录下的 not-found.tsx, 嵌套路由下手动调用 notFound 函数渲染局部 not-found.tsx</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  app</span></span><br><span class="line"><span class="comment">    products</span></span><br><span class="line"><span class="comment">      comments</span></span><br><span class="line"><span class="comment">        page.tsx // 调用 notFound 函数渲染当前路由段下的 not-found.tsx</span></span><br><span class="line"><span class="comment">        not-found.tsx</span></span><br><span class="line"><span class="comment">    layout.tsx</span></span><br><span class="line"><span class="comment">    page.tsx</span></span><br><span class="line"><span class="comment">    not-found.tsx</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure></li>
<li><p>error.tsx 允许处理运行时的错误并显示回退 UI</p>
<ul>
<li>Props<ul>
<li>error</li>
<li>reset</li>
</ul>
</li>
</ul>
</li>
<li><p>global-error.tsx 处理在根 layout 或 template 抛出的错误, 必须使用 html 和 body 标签, 这个文件将替换根 layout 或 template</p>
</li>
</ul>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/blog/error.tsx</span></span><br><span class="line"><span class="comment">// 处理在嵌套路由段下抛出的错误</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Error</span>(<span class="params">&#123; error &#125;: &#123;</span></span><br><span class="line"><span class="params">  error: <span class="built_in">Error</span>;</span></span><br><span class="line"><span class="params">  reset: () =&gt; <span class="built_in">void</span></span></span><br><span class="line"><span class="params">&#125;</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&#x27;container text-center text-red-500 text-3xl&#x27;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      blog error</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">br</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;error.message&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// global-error.tsx</span></span><br><span class="line"><span class="comment">// 处理在根 layout 或 template 抛出的错误</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">GlobalError</span>(<span class="params">&#123;</span></span><br><span class="line"><span class="params">  error,</span></span><br><span class="line"><span class="params">  reset</span></span><br><span class="line"><span class="params">&#125;: &#123;</span></span><br><span class="line"><span class="params">  error: <span class="built_in">Error</span> &amp; &#123; digest?: <span class="built_in">string</span> &#125;;</span></span><br><span class="line"><span class="params">  reset: () =&gt; <span class="built_in">void</span></span></span><br><span class="line"><span class="params">&#125;</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&#x27;text-red-500 text-2xl&#x27;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          global-error</span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">br</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">          &#123;error.message&#125;<span class="tag">&lt;<span class="name">br</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">          &#123;error.digest&#125;<span class="tag">&lt;<span class="name">br</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">Button</span> <span class="attr">type</span>=<span class="string">&quot;primary&quot;</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> reset()&#125;&gt;Try again<span class="tag">&lt;/<span class="name">Button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>default.tsx 用于在 Nextjs 在加载完整页面后无法恢复 <code>插槽</code> 的活动状态时使用. 刷新页面(硬导航)时, 为与当前 URL 未匹配的子页面渲染内容, 如果不存在则渲染 404<ul>
<li>Props<ul>
<li>params 动态路由参数, 一个 Promise, Next.js 14 之前是同步的</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 插槽不是路由段, 不能够影响 url, 插槽和正常页面合并之后形成与路由相关的最终页面,</span></span><br><span class="line"><span class="comment">// 因此, 在相同的路由段上不能有单独的静态渲染和动态插槽, 如果有一个插槽是动态的, 则该路由段的所有插槽都必须是动态的</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Link 组件软导航访问 /dashboard 和 /dashboard/visitor 页面时, 页面内容显示正常</span></span><br><span class="line"><span class="comment">// 硬导航 /dashboard/visitor 时, 无法恢复 并行路由(插槽) 状态,</span></span><br><span class="line"><span class="comment">// 需要提供已使用未匹配的 动态插槽 的 default.tsx 渲染内容 </span></span><br><span class="line"><span class="comment">// 否则将渲染 404</span></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment">  app</span></span><br><span class="line"><span class="comment">    dashboard</span></span><br><span class="line"><span class="comment">      setting       ✕</span></span><br><span class="line"><span class="comment">        page.tsx</span></span><br><span class="line"><span class="comment">      @team</span></span><br><span class="line"><span class="comment">        default.tsx ✓</span></span><br><span class="line"><span class="comment">        page.tsx</span></span><br><span class="line"><span class="comment">      @blor           // 动态插槽未使用不需要提供 default.tsx</span></span><br><span class="line"><span class="comment">        page.tsx</span></span><br><span class="line"><span class="comment">      @analytics</span></span><br><span class="line"><span class="comment">        page.tsx</span></span><br><span class="line"><span class="comment">        visitor</span></span><br><span class="line"><span class="comment">          page.tsx</span></span><br><span class="line"><span class="comment">      default.tsx   ✓</span></span><br><span class="line"><span class="comment">      layout.tsx</span></span><br><span class="line"><span class="comment">      page.tsx</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h3 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h3><p>环境变量自动加载到 route handlers</p>
<ul>
<li>使用 .env 加载环境变量</li>
<li>在 next.js 运行时外使用 <code>@next/env</code> 包中的 <code>loadEnvConfig</code> 函数加载环境变量</li>
<li>只有以 <code>NEXT_PUBLIC_</code> 开头的环境变量才会导出给客户端</li>
</ul>
<p>加载顺序</p>
<ol>
<li>process.env</li>
<li>.env.$(NODE_ENV).local</li>
<li>.env.local (Not checked when NODE_ENV is test)</li>
<li>.env.$(NODE_ENV)</li>
<li>.env</li>
</ol>
<h2 id="路由结构"><a href="#路由结构" class="headerlink" title="路由结构"></a>路由结构</h2><ul>
<li><p>pages 以当前目录下的 文件名 创建路由段, 目录下的 index.tsx 创建页面</p>
<ul>
<li>[fileName] 动态路由, 动态路由参数可以在 <code>layout.tsx</code>, <code>page.tsx</code>, <code>route.ts</code> 和 <code>generateMetadata</code> 中获取<ul>
<li>[…fileName] 截获所有动态路由参数</li>
<li>[[…fileName]] 可选的截获所有动态路由参数, 同时会截获不带任何动态参数的路由</li>
</ul>
</li>
</ul>
</li>
<li><p>app 以当前目录下的 目录名 创建路由段, 目录下的 page.tsx 创建页面</p>
<ul>
<li><p>_folderName 私有目录, 当前目录及子目录被 <code>路由解析 忽略</code>, 将 _ 转义后命名目录路由段可正常访问</p>
</li>
<li><p>(folderName) 路由分组, 目录名被 <code>路由解析 忽略</code>, 使用相同的布局</p>
</li>
<li><p>@folderName 并行路由, 被 <code>路由解析 忽略</code>. 同时或有条件地 在同一 layout.tsx 中渲染一个或多个页面.</p>
<p>不能够影响 url, 插槽和正常页面合并之后形成与路由相关的最终页面.</p>
<p>使用 <code>插槽</code> 渲染页面, 硬导航时无法恢复未匹配路由的插槽的活动状态时使用插槽的 default.tsx 渲染.</p>
</li>
</ul>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 访问 / 同时渲染 app/pages.tsx, @team/page.tsx, @analytics/page.tsx</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Layout</span>(<span class="params">&#123; children, team, analytics &#125;: <span class="keyword">readonly</span>&lt;&#123;</span></span><br><span class="line"><span class="params">    children: React.ReactNode;</span></span><br><span class="line"><span class="params">    team: React.ReactNode;</span></span><br><span class="line"><span class="params">    analytics: React.ReactNode;</span></span><br><span class="line"><span class="params">  &#125;&gt;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="language-xml"><span class="tag">&lt;&gt;</span></span></span><br><span class="line"><span class="language-xml">        &#123;children&#125;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;flex justify-center items-center&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          &#123;team&#125;</span></span><br><span class="line"><span class="language-xml">          &#123;analytics&#125;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/&gt;</span></span></span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>[folderName] 动态路由, 动态路由参数可以在 <code>layout.tsx</code>, <code>page.tsx</code>, <code>route.ts</code> 和 <code>generateMetadata</code> 中获取</p>
<ul>
<li>[…folderName] 截获所有动态路由参数</li>
<li>[[…folerName]] 可选的截获所有动态路由参数, 同时会截获不带任何动态参数的路由</li>
</ul>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  app</span></span><br><span class="line"><span class="comment">    photo</span></span><br><span class="line"><span class="comment">      [id]</span></span><br><span class="line"><span class="comment">        page.tsx</span></span><br><span class="line"><span class="comment">    doc</span></span><br><span class="line"><span class="comment">      [[...slug]]</span></span><br><span class="line"><span class="comment">        page.tsx</span></span><br><span class="line"><span class="comment">    page.tsx</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure></li>
<li><p>(..)folderName 拦截路由, 在另一个页面中使用布局渲染拦截当前路由</p>
<ul>
<li>(.)folderName 匹配同一级的路由</li>
<li>(..)folderName 匹配上一级的路由</li>
<li>(..)(..)folderName 匹配上上一级的路由</li>
<li>(…)folderName 匹配根路由</li>
</ul>
</li>
</ul>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在 app/page.tsx 软导航 /photo/110 将渲染拦截路由 @modal/(.)photo/[id]/page.tsx 下的内容</span></span><br><span class="line"><span class="comment">// 硬导航 /photo/110 时渲染 app/photo/[id]/page.tsx</span></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment">  app</span></span><br><span class="line"><span class="comment">    @modal</span></span><br><span class="line"><span class="comment">      default.tsx // 返回 null 在未匹配到 插槽 时不渲染内容</span></span><br><span class="line"><span class="comment">      (.)photo</span></span><br><span class="line"><span class="comment">        [id]</span></span><br><span class="line"><span class="comment">          page.tsx</span></span><br><span class="line"><span class="comment">    photo</span></span><br><span class="line"><span class="comment">      [id]</span></span><br><span class="line"><span class="comment">        page.tsx</span></span><br><span class="line"><span class="comment">    layout.tsx  </span></span><br><span class="line"><span class="comment">    page.tsx</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="路由段"><a href="#路由段" class="headerlink" title="路由段"></a>路由段</h2><p>直接在 layout, page, route handlers 中导出以下配置修改行为</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 阻止页面预渲染, 如果使用 cookies, headers, searchParams prop, connection, draftMode, unstable_noStore 等函数页面自动被视为动态渲染</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="attr">dynamic</span>: <span class="built_in">string</span> = <span class="string">&#x27;force-dynamic&#x27;</span>;  <span class="comment">// auto | force-dynamic | error | force-static</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// layout 和 page 启用部分渲染</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="attr">experimental_ppr</span>: <span class="built_in">boolean</span> = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 控制访问非 generateStaticParams 生成的动态段时会发生什么</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="attr">dyanmicParams</span>: <span class="built_in">boolean</span> = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置 layout 和 page 的验证时间间隔(秒)</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="attr">revalidate</span>: <span class="built_in">boolean</span> | <span class="built_in">number</span> = <span class="literal">false</span>; <span class="comment">// false | 0 | number</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 高级设置, 如果需要重置默认行为时使用</span></span><br><span class="line"><span class="comment">// export const fetchCache: string = &#x27;auto&#x27;; // auto | default-cache | only-cache | force-cache | force-no-store | default-no-store | only-no-store</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置运行时</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="attr">runtime</span>: <span class="built_in">string</span> = <span class="string">&#x27;nodejs&#x27;</span>;  <span class="comment">//nodejs | edge</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置首选区域</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="attr">preferredRegion</span>: <span class="built_in">string</span> = <span class="string">&#x27;auto&#x27;</span>; <span class="comment">// auto | global | home | string | string[]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 限制服务器端逻辑的执行时长, next.js 默认不限制</span></span><br><span class="line"><span class="comment">// export const maxDuration: number = 0;</span></span><br></pre></td></tr></table></figure>

<h2 id="dynamic-APIs"><a href="#dynamic-APIs" class="headerlink" title="dynamic APIs"></a>dynamic APIs</h2><p>动态 APIs 依赖于只能在请求时知道的信息(而不是在预渲染期间提前知道的信息), 使用这些 API 都表明了将在请求时选择整个路由进行动态渲染</p>
<ul>
<li>cookies</li>
<li>headers</li>
<li>connection</li>
<li>draftMode</li>
<li>searchParams prop</li>
<li>unstable_noStore</li>
</ul>
<h2 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h2><h3 id="Request-Memoization"><a href="#Request-Memoization" class="headerlink" title="Request Memoization"></a>Request Memoization</h3><p>是 React 的一个特性, next.js 扩展了 fetch API, 自动缓存相同的请求, 在 react 组件树中为相同的数据多次调用 fetch 函数将只执行一次</p>
<p>渲染路由时, 第一次调用特定请求时结果不在内存中而是缓存 <code>MISS</code>, 函数将被执行获取外部数据后存储到内存中,<br>在同一渲染过程中, 请求的后续函数调用将是缓存 <code>HIT</code>, 数据在不执行函数的情况下从内存中返回,<br>一旦路由被渲染并且渲染过程完成时, 内存将会被 <code>重置</code>, 所有请求记忆都会被清除</p>
<ul>
<li>仅适用于 fetch 请求中的 GET 方法, 其他请求方法不会被记忆</li>
<li>仅适用于 React 组件树, 例如 <code>generateMetadata</code>、<code>generateStaticParams</code>、Layout、Page 和其他服务器组件中, route handlers 不适用因为不属于 React 组件树</li>
</ul>
<p>不推荐退出请求记忆</p>
<h3 id="Data-Cache-数据缓存"><a href="#Data-Cache-数据缓存" class="headerlink" title="Data Cache 数据缓存"></a>Data Cache 数据缓存</h3><p>next.js 有一个内置的数据缓存, 可以在传入的服务器请求和部署中持久保持数据获取的结果</p>
<ul>
<li>使用 fetch(‘’, {cache: ‘force-cache’}) 强制使用缓存</li>
<li>使用 fetch(‘’, {cache: ‘force-cache’, next: { revalidate: 3600 }}) 设置 next.js 验证数据的时间间隔(秒)</li>
<li>cache mode, default | no-store | reload | no-cache | force-cache<ul>
<li>force-cache, 自己先在缓存中查找资源, 如果有不管是否过期直接返回</li>
<li>default, 自己先在缓存中查找资源, 然后验证资源是否过期, 如果过期再询问服务器资源是否过期</li>
<li>no-cache, 自己先在缓存中查找资源, 然后再询问服务器资源是否过期</li>
<li>reload, 不查看缓存, 直接从服务器获取资源, 然后使用下载的资源更新缓存</li>
<li>no-store, 不查看缓存, 直接从服务器获取资源, 并且不会更新缓存资源</li>
</ul>
</li>
</ul>
<p>退出数据缓存</p>
<ul>
<li>使用 fetch 不指定 cache 参数或者指定 {cache: ‘no-store’}</li>
</ul>
<h3 id="Full-Route-Cache-完整路由缓存"><a href="#Full-Route-Cache-完整路由缓存" class="headerlink" title="Full Route Cache 完整路由缓存"></a>Full Route Cache 完整路由缓存</h3><p>next.js 在构建时自动渲染和缓存路由, 而不是在服务器上为每个请求渲染从而加快页面加载速度</p>
<ul>
<li>使用流式 <code>服务器组件载荷</code>(RSC Payload) 和 Client Component 指令渲染 HTML, 返回响应而无需等待所有渲染完成</li>
<li>默认缓存路由的渲染结果</li>
</ul>
<p>退出完整路由缓存</p>
<ul>
<li>使用 dynamic APIs, cookies, headers, connection, draftMode, searchParams prop, unstable_noStore</li>
<li>在 layout、page、route Handler 中 export const dynamic = ‘force-dynamic’; 或者 export const revalidate = 0;</li>
<li>退出 Data Cache, 如果路由有一个未缓存的获取请求, 这将该路由退出完整路由缓存为每个请求获取特定数据, 其他未退出数据缓存的获取请求仍将缓存在数据缓存中<br>这允许缓存和未缓存数据的混合.</li>
</ul>
<h3 id="Router-Cache-路由缓存"><a href="#Router-Cache-路由缓存" class="headerlink" title="Router Cache 路由缓存"></a>Router Cache 路由缓存</h3><p>next.js 有一个客户端的路由缓存, 用于存储路由段的 RSC(React Server Component) 载荷, 按 layout、加载状态和 page 划分</p>
<p>当用户在路由之间导航时, next.js 会缓存访问过的路由段, 并预取用户可能导航到的路由, 导航之间不会重新加载整个页面, 并保留 React 状态和浏览器状态</p>
<ul>
<li>布局被缓存并在导航时重用(部分渲染)</li>
<li>加载状态被缓存并在导航中重用, 以实现即时导航</li>
<li>默认页面不会被缓存, 但在浏览器向前和向后导航期间会被重用</li>
</ul>
<h2 id="元数据"><a href="#元数据" class="headerlink" title="元数据"></a>元数据</h2><p>元数据支持两种方式配置, <code>配置文件</code> 和 <code>动态生成</code></p>
<p>favicon</p>
<ul>
<li>使用图片文件放在 app 目录下</li>
<li>使用代码生成图标文件</li>
</ul>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/icon.tsx</span></span><br><span class="line"><span class="keyword">import</span> &#123;<span class="title class_">ImageResponse</span>&#125; <span class="keyword">from</span> <span class="string">&#x27;next/og&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> size = &#123;<span class="attr">width</span>: <span class="number">32</span>, <span class="attr">height</span>: <span class="number">32</span>&#125;;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> contentType = <span class="string">&#x27;image/png&#x27;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Icon</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ImageResponse</span>(</span><br><span class="line">    (</span><br><span class="line">      <span class="comment">// ImageResponse JSX element</span></span><br><span class="line">      <span class="language-xml"><span class="tag">&lt;<span class="name">div</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">style</span>=<span class="string">&#123;&#123;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">fontSize:</span> <span class="attr">24</span>,</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">background:</span> &#x27;<span class="attr">black</span>&#x27;,</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">width:</span> &#x27;<span class="attr">100</span>%&#x27;,</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">height:</span> &#x27;<span class="attr">100</span>%&#x27;,</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">display:</span> &#x27;<span class="attr">flex</span>&#x27;,</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">alignItems:</span> &#x27;<span class="attr">center</span>&#x27;,</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">justifyContent:</span> &#x27;<span class="attr">center</span>&#x27;,</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">color:</span> &#x27;<span class="attr">white</span>&#x27;,</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        &#125;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">      &gt;</span></span></span><br><span class="line"><span class="language-xml">        A</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    ),</span><br><span class="line">    <span class="comment">// ImageResponse options</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// For convenience, we can re-use the exported icons size metadata</span></span><br><span class="line">      <span class="comment">// config to also set the ImageResponse&#x27;s width and height.</span></span><br><span class="line">      ...size,</span><br><span class="line">    &#125;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>metadata <em id ="metadata"></em> <!--markdownlint-disable-line--> </p>
<p>不能在相同的路由段中同时使用 静态配置 和 动态生成 两种方式, 从 layout.tsx 或 page.tsx 中导出</p>
<p>导出 metadata 时不能使用 <code>&#39;use client&#39;</code> 指令标识组件为客户端组件</p>
<ul>
<li>静态配置</li>
<li>使用 <code>generateMetadata</code> 函数动态生成</li>
</ul>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// layout.tsx, page.tsx</span></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">type</span> &#123;<span class="title class_">Metadata</span>, <span class="title class_">ResolvingMetadata</span>&#125; <span class="keyword">from</span> <span class="string">&quot;next&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Counter</span> <span class="keyword">from</span> <span class="string">&#x27;./counter&#x27;</span>; <span class="comment">// import client component with &#x27;use client&#x27; directive.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// static metatdata</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="attr">metadata</span>: <span class="title class_">Metadata</span> = &#123;</span><br><span class="line">  <span class="attr">title</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="attr">description</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="attr">generator</span>: <span class="string">&#x27;Next.js&#x27;</span>,</span><br><span class="line">  <span class="attr">applicationName</span>: <span class="string">&#x27;Next.js&#x27;</span>,</span><br><span class="line">  <span class="attr">referrer</span>: <span class="string">&#x27;origin-when-cross-origin&#x27;</span>,</span><br><span class="line">  <span class="attr">keywords</span>: [<span class="string">&#x27;Next.js&#x27;</span>, <span class="string">&#x27;React&#x27;</span>, <span class="string">&#x27;JavaScript&#x27;</span>],</span><br><span class="line">  <span class="attr">authors</span>: [&#123; <span class="attr">name</span>: <span class="string">&#x27;Seb&#x27;</span> &#125;, &#123; <span class="attr">name</span>: <span class="string">&#x27;Josh&#x27;</span>, <span class="attr">url</span>: <span class="string">&#x27;https://nextjs.org&#x27;</span> &#125;],</span><br><span class="line">  <span class="attr">creator</span>: <span class="string">&#x27;Jiachi Liu&#x27;</span>,</span><br><span class="line">  <span class="attr">publisher</span>: <span class="string">&#x27;Sebastian Markbåge&#x27;</span>,</span><br><span class="line">  <span class="attr">formatDetection</span>: &#123;</span><br><span class="line">    <span class="attr">email</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">address</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">telephone</span>: <span class="literal">false</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">openGraph</span>: &#123;&#125;,</span><br><span class="line">  <span class="attr">robots</span>: &#123;&#125;</span><br><span class="line">  <span class="attr">icons</span>: &#123;&#125;,</span><br><span class="line">  <span class="attr">colorScheme</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  <span class="attr">manifest</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  <span class="attr">twitter</span>: &#123;&#125;,</span><br><span class="line">  <span class="attr">viewport</span>: &#123;&#125;,</span><br><span class="line">  <span class="attr">alternates</span>: &#123;&#125;,</span><br><span class="line">  <span class="attr">assets</span>: [],</span><br><span class="line">  <span class="attr">category</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  <span class="attr">bookmarks</span>: [],</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// dynamic metadata</span></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">Props</span> = &#123;</span><br><span class="line">  <span class="attr">params</span>: <span class="title class_">Promise</span>&lt;&#123;<span class="attr">id</span>: <span class="built_in">string</span>&#125;&gt;,</span><br><span class="line">  <span class="attr">searchParams</span>: <span class="title class_">Promise</span>&lt;&#123; [<span class="attr">key</span>: <span class="built_in">string</span>]: <span class="built_in">string</span> | <span class="built_in">string</span>[] | <span class="literal">undefined</span> &#125;&gt;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">generateMetadata</span>(<span class="params">&#123;params, searchParams&#125;: <span class="title class_">Props</span>, <span class="attr">parent</span>: <span class="title class_">ResolvingMetadata</span></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">Metadata</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;id&#125; = params;</span><br><span class="line">  <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">fetch</span>();</span><br><span class="line">  <span class="keyword">return</span> &#123;<span class="attr">title</span>: <span class="string">&quot;&quot;</span>, <span class="attr">description</span>: <span class="string">&quot;&quot;</span>&#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Page</span>(<span class="params">&#123;params, searchParams&#125;: <span class="title class_">Props</span></span>)&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Counter</span> /&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// couter.tsx 使用 client component hooks.</span></span><br><span class="line"><span class="string">&#x27;use client&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">React</span>, &#123; useState &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Counter</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = <span class="title function_">useState</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">p</span>&gt;</span>count is &#123;count&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setCount(count + 1)&#125;&gt;Click<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>viewport 页面视窗 <em id="viewport"></em> <!--markdownlint-disable-line--></p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// layout.tsx, page.tsx</span></span><br><span class="line"><span class="comment">// static viewport</span></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">type</span> &#123;<span class="title class_">Viewport</span>&#125; <span class="keyword">from</span> <span class="string">&#x27;next&#x27;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="attr">viewport</span>: <span class="title class_">Viewport</span> = &#123;</span><br><span class="line">  <span class="attr">themeColor</span>: <span class="string">&#x27;black&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// dynamic viewport</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">generateViewport</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Page</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>manifest</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/manifest.json</span></span><br><span class="line"><span class="comment">// static manifest</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;name&quot;</span>: <span class="string">&quot;My Next.js Application&quot;</span>,</span><br><span class="line">  <span class="string">&quot;short_name&quot;</span>: <span class="string">&quot;Next.js App&quot;</span>,</span><br><span class="line">  <span class="string">&quot;description&quot;</span>: <span class="string">&quot;An application built with Next.js&quot;</span>,</span><br><span class="line">  <span class="string">&quot;start_url&quot;</span>: <span class="string">&quot;/&quot;</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// app/manifest.ts</span></span><br><span class="line"><span class="comment">// dynamic manifest</span></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">type</span> &#123; <span class="title class_">MetadataRoute</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;next&#x27;</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">manifest</span>(<span class="params"></span>): <span class="title class_">MetadataRoute</span>.<span class="property">Manifest</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Next.js App&#x27;</span>,</span><br><span class="line">    <span class="attr">short_name</span>: <span class="string">&#x27;Next.js App&#x27;</span>,</span><br><span class="line">    <span class="attr">description</span>: <span class="string">&#x27;Next.js App&#x27;</span>,</span><br><span class="line">    <span class="attr">start_url</span>: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">    <span class="attr">display</span>: <span class="string">&#x27;standalone&#x27;</span>,</span><br><span class="line">    <span class="attr">background_color</span>: <span class="string">&#x27;#fff&#x27;</span>,</span><br><span class="line">    <span class="attr">theme_color</span>: <span class="string">&#x27;#fff&#x27;</span>,</span><br><span class="line">    <span class="attr">icons</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">src</span>: <span class="string">&#x27;/favicon.ico&#x27;</span>,</span><br><span class="line">        <span class="attr">sizes</span>: <span class="string">&#x27;any&#x27;</span>,</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;image/x-icon&#x27;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>robots</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/robots.txt</span></span><br><span class="line"><span class="comment">// static robots</span></span><br><span class="line"><span class="comment">/* */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// app/robots.ts</span></span><br><span class="line"><span class="comment">// dynamic robots</span></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">type</span> &#123; <span class="title class_">MetadataRoute</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;next&#x27;</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">robots</span>(<span class="params"></span>): <span class="title class_">MetadataRoute</span>.<span class="property">Robots</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">rules</span>: &#123;</span><br><span class="line">      <span class="attr">userAgent</span>: <span class="string">&#x27;*&#x27;</span>,</span><br><span class="line">      <span class="attr">allow</span>: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">      <span class="attr">disallow</span>: <span class="string">&#x27;/private/&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">sitemap</span>: <span class="string">&#x27;https://acme.com/sitemap.xml&#x27;</span>,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>sitemap <em id="sitemap"></em> <!--markdownlint-disable-line--></p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/sitemap.xml</span></span><br><span class="line"><span class="comment">// static sitemap</span></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment">  &lt;xml&gt;</span></span><br><span class="line"><span class="comment">    &lt;property&gt;&lt;/property&gt;</span></span><br><span class="line"><span class="comment">  &lt;/xml&gt;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// app/sitemap.ts</span></span><br><span class="line"><span class="comment">// dynamic sitemap</span></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">type</span> &#123; <span class="title class_">MetadataRoute</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;next&#x27;</span></span><br><span class="line"><span class="comment">// generateSitemaps 分割 sitemap 为多个 xml, 返回一个对象数组, id 作为 sitemap 的参数</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">generateSitemaps</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="keyword">return</span> [&#123;<span class="attr">id</span>: <span class="number">0</span>&#125;, &#123;<span class="attr">id</span>: <span class="number">1</span>&#125;, &#123;<span class="attr">id</span>: <span class="number">2</span>&#125;];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">sitemap</span>(<span class="params">&#123;id&#125;: &#123;id: <span class="built_in">number</span>&#125;</span>): <span class="title class_">MetadataRoute</span>.<span class="property">Sitemap</span> &#123;</span><br><span class="line"> <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h2><ul>
<li>headers 一个 async 函数, 在服务器组件内读取请求头信息</li>
<li>cookies 一个 async 函数, 在服务器组件内读取请求中的 cookies</li>
</ul>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// page.tsx</span></span><br><span class="line"><span class="keyword">import</span> &#123;cookies, headers&#125; <span class="keyword">from</span> <span class="string">&#x27;next/headers&#x27;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">Page</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="keyword">const</span> headersList = <span class="keyword">await</span> <span class="title function_">headers</span>();</span><br><span class="line">  <span class="keyword">const</span> ua = headersList.<span class="title function_">get</span>(<span class="string">&#x27;user-agent&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> cookieStore = <span class="keyword">await</span> <span class="title function_">cookies</span>();</span><br><span class="line">  <span class="keyword">const</span> theme = cookieStore.<span class="title function_">get</span>(<span class="string">&#x27;theme&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="string">&#x27;...&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>NextRequest 扩展了 Web Request API</p>
</li>
<li><p>NextResponse 扩展了 Web Response API</p>
</li>
<li><p>notFound 调用方法将抛出 <code>NEXT_NOT_FOUND</code> 错误, 渲染 not-found.tsx 内容</p>
</li>
<li><p>permanentRedirect 永久重定向, 返回 308(HTTP), 如果资源不存在可以使用 notFound 函数代替</p>
</li>
<li><p>redirect 重定向</p>
<ul>
<li>path</li>
<li>type, replace(default) | push</li>
</ul>
</li>
<li><p>revalidatePath 按需清理特定路径的缓存数据</p>
<ul>
<li>path</li>
<li>type, page | layout</li>
</ul>
</li>
<li><p>revalidateTag 按需清理特定缓存标记的缓存数据</p>
<ul>
<li>tag</li>
</ul>
</li>
<li><p>after 注册在响应结束之后执行的任务, 通常记录日志和数据分析</p>
</li>
</ul>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// layout.tsx</span></span><br><span class="line"><span class="keyword">import</span> &#123;after&#125; <span class="keyword">from</span> <span class="string">&#x27;next/server&#x27;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Layout</span>(<span class="params">&#123;children&#125;</span>)&#123;</span><br><span class="line">  <span class="title function_">after</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// layout 渲染完成发送给请求后执行</span></span><br><span class="line">    <span class="title function_">log</span>();</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      Hello World</span></span><br><span class="line"><span class="language-xml">      &#123;children&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>connection 标记渲染内容等待用户的请求传入</li>
</ul>
<p>当不使用 dynamic APIs 时希望在运行时动态渲染而不是在构建时静态渲染, 通常用在访问有意更改渲染结果的外部信息时</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// page.tsx</span></span><br><span class="line"><span class="keyword">import</span> &#123;connection&#125; <span class="keyword">from</span> <span class="string">&#x27;next/server&#x27;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">Page</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">connection</span>(); <span class="comment">// 等待请求传入</span></span><br><span class="line">  <span class="comment">// Everything below will be excluded from prerendering</span></span><br><span class="line">  <span class="keyword">const</span> rand = <span class="title class_">Math</span>.<span class="title function_">rand</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;rand&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>drafMode 启用或禁用草稿模式(draftMode), async 函数<ul>
<li>isEnabled, 标识 draftMode 是否启用</li>
<li>enable(), 启用 draftMode</li>
<li>disable(), 禁用 draftMode</li>
</ul>
</li>
</ul>
<p>草稿模式允许在 next.js 应用程序中预览无头 CMS 中的草稿内容而无需重建整个网站, 对于在构建时静态渲染的内容允许切换到动态渲染并查看更改非常有用</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// page.tsx</span></span><br><span class="line"><span class="keyword">import</span> &#123;draftMode&#125; <span class="keyword">from</span> <span class="string">&#x27;next/server&#x27;</span>;</span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getData</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;isEnabled&#125; = <span class="keyword">await</span> <span class="title function_">draftMode</span>();</span><br><span class="line">  <span class="keyword">const</span> url = isEnabled ? <span class="string">&#x27;https://draft.example.com&#x27;</span> : <span class="string">&#x27;https://product.example.com&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">fetch</span>(url);</span><br><span class="line">  <span class="keyword">return</span> res.<span class="title function_">json</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">Page</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;title, desc&#125; = <span class="keyword">await</span> <span class="title function_">getData</span>();</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">main</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;title&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;desc&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">main</span>&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// app/api/draft/route.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123;draftMode, <span class="title class_">NextRequest</span>&#125; <span class="keyword">from</span> <span class="string">&#x27;next/server&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;redirect&#125; <span class="keyword">from</span> <span class="string">&#x27;next/navigation&#x27;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">GET</span>(<span class="params"><span class="attr">request</span>: <span class="title class_">NextRequest</span></span>) &#123;</span><br><span class="line">  <span class="comment">// Parse query string parameters</span></span><br><span class="line">  <span class="keyword">const</span> &#123; searchParams &#125; = <span class="keyword">new</span> <span class="title function_">URL</span>(request.<span class="property">nextUrl</span>)</span><br><span class="line">  <span class="keyword">const</span> secret = searchParams.<span class="title function_">get</span>(<span class="string">&#x27;secret&#x27;</span>)</span><br><span class="line">  <span class="keyword">const</span> slug = searchParams.<span class="title function_">get</span>(<span class="string">&#x27;slug&#x27;</span>)</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// Check the secret and next parameters</span></span><br><span class="line">  <span class="comment">// This secret should only be known to this Route Handler and the CMS</span></span><br><span class="line">  <span class="keyword">if</span> (secret !== <span class="string">&#x27;MY_SECRET_TOKEN&#x27;</span> || !slug) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Response</span>(<span class="string">&#x27;Invalid token&#x27;</span>, &#123; <span class="attr">status</span>: <span class="number">401</span> &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// Fetch the headless CMS to check if the provided `slug` exists</span></span><br><span class="line">  <span class="comment">// getPostBySlug would implement the required fetching logic to the headless CMS</span></span><br><span class="line">  <span class="keyword">const</span> post = <span class="keyword">await</span> <span class="title function_">getPostBySlug</span>(slug)</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// If the slug doesn&#x27;t exist prevent draft mode from being enabled</span></span><br><span class="line">  <span class="keyword">if</span> (!post) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Response</span>(<span class="string">&#x27;Invalid slug&#x27;</span>, &#123; <span class="attr">status</span>: <span class="number">401</span> &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// Enable Draft Mode by setting the cookie</span></span><br><span class="line">  <span class="keyword">const</span> draft = <span class="keyword">await</span> <span class="title function_">draftMode</span>()</span><br><span class="line">  draft.<span class="title function_">enable</span>()</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// Redirect to the path from the fetched post</span></span><br><span class="line">  <span class="comment">// We don&#x27;t redirect to searchParams.slug as that might lead to open redirect vulnerabilities</span></span><br><span class="line">  <span class="title function_">redirect</span>(post.<span class="property">slug</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>fetch 扩展了 Web fetch API</li>
<li>generateImageMetadata 生成一个或多个不同版本的图片元数据, 希望避免硬编码元数据时例如 Icon<ul>
<li>params, 一个 Promise, Next.js 14 之前是同步的</li>
<li>返回值<ul>
<li>id, string,required</li>
<li>alt, string</li>
<li>size, {width: number, height: number}</li>
<li>contentType, string</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;<span class="title class_">ImageResponse</span>&#125; <span class="keyword">from</span> <span class="string">&#x27;next/og&#x27;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">generateImageMetadata</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="keyword">return</span> [</span><br><span class="line">    &#123;<span class="attr">id</span>: <span class="string">&#x27;small&#x27;</span>, <span class="attr">contentType</span>: <span class="string">&#x27;image/png&#x27;</span>, <span class="attr">size</span>: &#123;<span class="attr">width</span>: <span class="number">40</span>, <span class="attr">height</span>: <span class="number">40</span>&#125;&#125;,</span><br><span class="line">    &#123;<span class="attr">id</span>: <span class="string">&#x27;medium&#x27;</span>, <span class="attr">contentType</span>: <span class="string">&#x27;image/png&#x27;</span>, <span class="attr">size</span>: &#123;<span class="attr">width</span>: <span class="number">72</span>, <span class="attr">height</span>: <span class="number">72</span>&#125;&#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Icon</span>(<span class="params">&#123;id&#125;: &#123;id: <span class="built_in">string</span>&#125;</span>)&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ImageResponse</span>((</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">      <span class="attr">style</span>=<span class="string">&#123;&#123;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">width:</span> &#x27;<span class="attr">100</span>%&#x27;,</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">height:</span> &#x27;<span class="attr">100</span>%&#x27;,</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">display:</span> &#x27;<span class="attr">flex</span>&#x27;,</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">alignItems:</span> &#x27;<span class="attr">center</span>&#x27;,</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">justifyContent:</span> &#x27;<span class="attr">center</span>&#x27;,</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">fontSize:</span> <span class="attr">88</span>,</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">background:</span> &#x27;#<span class="attr">000</span>&#x27;,</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">color:</span> &#x27;#<span class="attr">fafafa</span>&#x27;,</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">      &#125;&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml">      Icon &#123;id&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  ))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><a href="#metadata">generateMetadata</a> 生成页面元数据</li>
<li><a href="#sitemap">generateSitemaps</a> 生成应用站点地图</li>
<li>generateStaticParams 合并动态路由段和静态路由, 在构建时生成路由而不是在请求时按需生成<ul>
<li>Props<ul>
<li>params 动态路由参数, 一个 Promise, Next.js 14 之前是同步的</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">generateStaticParams</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> [</span><br><span class="line">    &#123; <span class="attr">category</span>: <span class="string">&#x27;a&#x27;</span>, <span class="attr">product</span>: <span class="string">&#x27;1&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">category</span>: <span class="string">&#x27;b&#x27;</span>, <span class="attr">product</span>: <span class="string">&#x27;2&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">category</span>: <span class="string">&#x27;c&#x27;</span>, <span class="attr">product</span>: <span class="string">&#x27;3&#x27;</span> &#125;,</span><br><span class="line">  ];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Three versions of this page will be statically generated</span></span><br><span class="line"><span class="comment">// using the `params` returned by `generateStaticParams`</span></span><br><span class="line"><span class="comment">// - /products/a/1</span></span><br><span class="line"><span class="comment">// - /products/b/2</span></span><br><span class="line"><span class="comment">// - /products/c/3</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">Page</span>(<span class="params">&#123;params&#125;: &#123;</span></span><br><span class="line"><span class="params">  params: <span class="built_in">Promise</span>&lt;&#123;category: <span class="built_in">string</span>, product: <span class="built_in">string</span>&#125;&gt;</span></span><br><span class="line"><span class="params">&#125;</span>)&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;categor, product&#125; = <span class="keyword">await</span> params;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><a href="#viewport">generateViewport</a> 生成页面的视窗配置</p>
</li>
<li><p>ImageResponse 图片构造函数, 生成动态图片 <code>import &#123; ImageResponse &#125; from &#39;next/og&#39;</code>;</p>
</li>
<li><p>unstable_cache 允许缓存昂贵操作的结果, 并在多个请求中重用它们, 使用 <code>use cache</code> 代替</p>
<ul>
<li>fetchData, 获取数据的异步函数</li>
<li>keyPairs, 一个额外的密钥数组, 为缓存添加标识</li>
<li>options 控制缓存的行为<ul>
<li>tags, 一组用于控制缓存失效的标签</li>
<li>revalidate, 缓存应该被验证的时间间隔(秒)</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> data = <span class="title function_">unstable_cache</span>(fetchData, keyParts, options)();</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; unstable_cache &#125; <span class="keyword">from</span> <span class="string">&#x27;next/cache&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> getCachedUser = <span class="title function_">unstable_cache</span>(<span class="title function_">async</span> (id) =&gt; <span class="title function_">getUser</span>(id), [<span class="string">&#x27;myy-app-user&#x27;</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">Component</span>(<span class="params">&#123; userId &#125;</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> user = <span class="keyword">await</span> <span class="title function_">getCachedUser</span>(userId)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>unstable_noStore 声明选择退出静态渲染, 并标识不应缓存特定组件, Next.js 15 使用 <code>connection</code> 代替</li>
</ul>
<h3 id="hook"><a href="#hook" class="headerlink" title="hook"></a>hook</h3><p>Client Component Hook</p>
<ul>
<li>useParams 获取动态路由参数</li>
<li>usePathname 获取当前 url 的路径</li>
<li>useReportWebVitals 获取网站性能指标</li>
<li>useRouter 编程式改变路由</li>
</ul>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;use client&#x27;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Page</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="keyword">const</span> router = <span class="title function_">useRouter</span>();</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (<span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    Hello World!</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> router.push(&#x27;/login&#x27;)&#125;&gt;login<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>useSearchParams 获取当前 url 查询参数</p>
</li>
<li><p>useSelectedLayoutSegment 获取当前 layout 下面一层的活动路由段, 通常用于在父布局中改变子段的状态</p>
</li>
<li><p>useSelectedLayoutSegments 获取当前 layout 下的活动路由段, 通常用于在父布局中改变子段的状态</p>
</li>
</ul>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/blog/blog-nav-link.tsx</span></span><br><span class="line"><span class="string">&#x27;use client&#x27;</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Link</span> <span class="keyword">from</span> <span class="string">&#x27;next/link&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; useSelectedLayoutSegment &#125; <span class="keyword">from</span> <span class="string">&#x27;next/navigation&#x27;</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// This *client* component will be imported into a blog layout</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">BlogNavLink</span>(<span class="params">&#123;</span></span><br><span class="line"><span class="params">  slug,</span></span><br><span class="line"><span class="params">  children,</span></span><br><span class="line"><span class="params">&#125;: &#123;</span></span><br><span class="line"><span class="params">  slug: <span class="built_in">string</span></span></span><br><span class="line"><span class="params">  children: React.ReactNode</span></span><br><span class="line"><span class="params">&#125;</span>) &#123;</span><br><span class="line">  <span class="comment">// Navigating to `/blog/hello-world` will return &#x27;hello-world&#x27;</span></span><br><span class="line">  <span class="comment">// for the selected layout segment</span></span><br><span class="line">  <span class="keyword">const</span> segment = <span class="title function_">useSelectedLayoutSegment</span>()</span><br><span class="line">  <span class="keyword">const</span> isActive = slug === segment</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">Link</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">      <span class="attr">href</span>=<span class="string">&#123;</span>`/<span class="attr">blog</span>/$&#123;<span class="attr">slug</span>&#125;`&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">      // <span class="attr">Change</span> <span class="attr">style</span> <span class="attr">depending</span> <span class="attr">on</span> <span class="attr">whether</span> <span class="attr">the</span> <span class="attr">link</span> <span class="attr">is</span> <span class="attr">active</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">      <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">fontWeight:</span> <span class="attr">isActive</span> ? &#x27;<span class="attr">bold</span>&#x27; <span class="attr">:</span> &#x27;<span class="attr">normal</span>&#x27; &#125;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">    &gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;children&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">Link</span>&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// app/blog/layout.tsx</span></span><br><span class="line"><span class="comment">// Import the Client Component into a parent Layout (Server Component)</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">BlogNavLink</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./blog-nav-link&#x27;</span></span><br><span class="line"><span class="keyword">import</span> getFeaturedPosts <span class="keyword">from</span> <span class="string">&#x27;./get-featured-posts&#x27;</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">Layout</span>(<span class="params">&#123;</span></span><br><span class="line"><span class="params">  children,</span></span><br><span class="line"><span class="params">&#125;: &#123;</span></span><br><span class="line"><span class="params">  children: React.ReactNode</span></span><br><span class="line"><span class="params">&#125;</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> featuredPosts = <span class="keyword">await</span> <span class="title function_">getFeaturedPosts</span>()</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;featuredPosts.map((post) =&gt; (</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">key</span>=<span class="string">&#123;post.id&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">BlogNavLink</span> <span class="attr">slug</span>=<span class="string">&#123;post.slug&#125;</span>&gt;</span>&#123;post.title&#125;<span class="tag">&lt;/<span class="name">BlogNavLink</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      ))&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;children&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>userAgent 获取 request 请求中的 user-agent</li>
</ul>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">NextRequest</span>, <span class="title class_">NextResponse</span>, userAgent &#125; <span class="keyword">from</span> <span class="string">&quot;next/server&quot;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">middleware</span>(<span class="params"><span class="attr">request</span>: <span class="title class_">NextRequest</span></span>)&#123;</span><br><span class="line">  <span class="keyword">const</span> ua = <span class="title function_">userAgent</span>(request);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ua&#x27;</span>, ua)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> requestHeaders = <span class="keyword">new</span> <span class="title class_">Headers</span>(request.<span class="property">headers</span>);</span><br><span class="line">  requestHeaders.<span class="title function_">set</span>(<span class="string">&#x27;x-hello-form-middleware&#x27;</span>, <span class="string">&#x27;hello&#x27;</span>);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> <span class="title class_">NextResponse</span>.<span class="title function_">next</span>(&#123;</span><br><span class="line">    <span class="attr">request</span>: &#123;</span><br><span class="line">      <span class="attr">headers</span>: requestHeaders</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

    </div>

    
    
    
      
  <div class="popular-posts-header">相关文章推荐</div>
  <ul class="popular-posts">
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="\2022\02\5ad505cb0ced\" rel="bookmark">React-Redux.md</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="\2022\02\7ec5bd96e943\" rel="bookmark">React.md</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="\2022\02\0eb429a8209b\" rel="bookmark">React-Router.md</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="\2022\02\18f2de6d45f9\" rel="bookmark">JSUtils</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="\2022\03\0734d1c7c12c\" rel="bookmark">JS</a></div>
    </li>
  </ul>

        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>luoleiself
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://luoleiself.github.io/2022/02/f3581d54a2fe/" title="React-Nextjs.md">https://luoleiself.github.io/2022/02/f3581d54a2fe/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/js/" rel="tag"># js</a>
              <a href="/tags/jsx/" rel="tag"># jsx</a>
              <a href="/tags/React/" rel="tag"># React</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/02/5ad505cb0ced/" rel="prev" title="React-Redux.md">
      <i class="fa fa-chevron-left"></i> React-Redux.md
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/02/18f2de6d45f9/" rel="next" title="JSUtils">
      JSUtils <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Server-Component"><span class="nav-number">1.</span> <span class="nav-text">Server Component</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RSC-Payload"><span class="nav-number">2.</span> <span class="nav-text">RSC Payload</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Server-Action"><span class="nav-number">2.1.</span> <span class="nav-text">Server Action</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Components"><span class="nav-number">2.2.</span> <span class="nav-text">Components</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E8%A7%84%E8%8C%83"><span class="nav-number">3.</span> <span class="nav-text">文件规范</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="nav-number">3.1.</span> <span class="nav-text">环境变量</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B7%AF%E7%94%B1%E7%BB%93%E6%9E%84"><span class="nav-number">4.</span> <span class="nav-text">路由结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B7%AF%E7%94%B1%E6%AE%B5"><span class="nav-number">5.</span> <span class="nav-text">路由段</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#dynamic-APIs"><span class="nav-number">6.</span> <span class="nav-text">dynamic APIs</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%93%E5%AD%98"><span class="nav-number">7.</span> <span class="nav-text">缓存</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Request-Memoization"><span class="nav-number">7.1.</span> <span class="nav-text">Request Memoization</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Data-Cache-%E6%95%B0%E6%8D%AE%E7%BC%93%E5%AD%98"><span class="nav-number">7.2.</span> <span class="nav-text">Data Cache 数据缓存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Full-Route-Cache-%E5%AE%8C%E6%95%B4%E8%B7%AF%E7%94%B1%E7%BC%93%E5%AD%98"><span class="nav-number">7.3.</span> <span class="nav-text">Full Route Cache 完整路由缓存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Router-Cache-%E8%B7%AF%E7%94%B1%E7%BC%93%E5%AD%98"><span class="nav-number">7.4.</span> <span class="nav-text">Router Cache 路由缓存</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%83%E6%95%B0%E6%8D%AE"><span class="nav-number">8.</span> <span class="nav-text">元数据</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%BD%E6%95%B0"><span class="nav-number">9.</span> <span class="nav-text">函数</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#hook"><span class="nav-number">9.1.</span> <span class="nav-text">hook</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="luoleiself"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">luoleiself</p>
  <div class="site-description" itemprop="description">努力的往前飞, 再累也无所谓, 黑夜过后的光芒有多美...</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">49</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">27</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/luoleiself" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;luoleiself" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:luoleiself@163.com" title="E-Mail → mailto:luoleiself@163.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fa fa-rss fa-fw"></i>RSS</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://developer.mozilla.org/zh-CN/" title="https:&#x2F;&#x2F;developer.mozilla.org&#x2F;zh-CN&#x2F;" rel="noopener" target="_blank">MDN</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2020 – 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">luoleiself</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">645k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">9:47</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div><!-- canvas-nest -->
<!-- modify source/_data/footer.swig -->
<!-- modify _config.next.yml -> custom_file_path:footer -->
<!--
<script color="0,0,255" opacity="0.7" zIndex="-1" count="200" src="//cdn.jsdelivr.net/npm/canvas-nest.js@1/dist/canvas-nest.js"></script> 
-->
<style>
.highlight-container ::selection {
  color: #fc7237
};
</style>


        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/lozad.js/1.14.0/lozad.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
